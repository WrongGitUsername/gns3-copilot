# GNS3 区域标注功能使用指南

## 概述

GNS3 Copilot 现在支持自动创建网络区域的可视化标注，帮助用户直观地理解网络拓扑结构，特别是对于 OSPF、EIGRP、BGP 等路由协议的区域划分。

## 功能特性

### 当前版本支持（v1.0）

- ✅ **两节点椭圆标注**：自动创建完美的椭圆连接两个网络设备
- ✅ **自动计算**：根据节点坐标自动计算椭圆尺寸、位置和旋转角度
- ✅ **智能配色**：根据区域类型自动选择颜色
  - Area 0（骨干区域）：绿色 (#00cc00)
  - Area 1-99（普通区域）：蓝色 (#3366ff)
  - 其他区域（EIGRP、BGP等）：灰色 (#999999)
- ✅ **专业样式**：虚线边框、半透明背景、居中标签

### 使用方式

用户只需要提供简单的区域信息，AI会自动完成所有复杂的计算和绘图工作。

## 使用示例

### 示例 1：OSPF Area 0（基础配置）

**用户输入：**
```
在R-1和R-2上配置OSPF，使用area 0
```

**AI执行流程：**
1. 配置 R-1 的 OSPF
2. 配置 R-2 的 OSPF
3. 自动调用 `create_gns3_area_drawing` 工具
4. 创建"Area 0"的可视化标注

**结果：**
- ✅ 完成 OSPF 配置
- ✅ 创建椭圆标注连接 R-1 和 R-2
- ✅ 椭圆中心显示"Area 0"标签

### 示例 2：OSPF 多区域网络

**用户输入：**
```
配置OSPF多区域网络，R-1和R-2在area 0，R-3和R-4在area 1
```

**AI执行流程：**
1. 配置所有路由器的 OSPF
2. 创建 Area 0 标注（R-1, R-2）
3. 创建 Area 1 标注（R-3, R-4）

**结果：**
- ✅ Area 0：绿色椭圆，包含 R-1 和 R-2
- ✅ Area 1：蓝色椭圆，包含 R-3 和 R-4

### 示例 3：EIGRP AS 配置

**用户输入：**
```
在SW-1和SW-2上配置EIGRP，AS号为100
```

**结果：**
- ✅ 完成 EIGRP 配置
- ✅ 创建"EIGRP AS 100"灰色椭圆标注

## 工具参数

`create_gns3_area_drawing` 工具只需要3个参数：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `project_id` | string | 是 | GNS3 项目 UUID |
| `area_name` | string | 是 | 区域名称（如 "Area 0", "AS 100"） |
| `node_names` | array | 是 | 恰好2个节点名称的列表 |

**输入示例：**
```json
{
  "project_id": "2245149a-71c8-4387-9d1f-441a683ef7e7",
  "area_name": "Area 0",
  "node_names": ["R-1", "R-2"]
}
```

## 算法说明

### 椭圆计算算法

工具使用以下步骤计算椭圆参数：

1. **计算中间点**：两个节点坐标的平均值作为椭圆中心
2. **计算距离**：使用欧几里得距离公式计算节点间距离
3. **确定尺寸**：
   - 长轴半径 (rx) = 距离/2 + padding（默认40px）
   - 短轴半径 (ry) = 设备高度（默认100px）
4. **计算角度**：使用 `atan2` 函数计算椭圆旋转角度
5. **生成 SVG**：创建椭圆和文本的 SVG 内容

### 颜色选择逻辑

工具根据区域名称自动选择颜色：

```python
if "Area 0" in area_name:
    return 绿色  # 骨干区域
elif "Area" in area_name:
    return 蓝色  # 普通 OSPF 区域
else:
    return 灰色  # 其他协议区域
```

## 限制说明

### 当前版本限制（v1.0）

- ⚠️ **仅支持2个节点**：每次调用只能标注2个设备
- ⚠️ **仅支持椭圆形状**：暂不支持矩形框标注
- ⚠️ **固定参数**：padding 和设备高度使用默认值

### 多节点处理建议

如果有3个或更多节点需要标注，请：

1. **分批处理**：将节点分成2个一组，多次调用工具
2. **创建多个标注**：每个区域可能需要多个椭圆
3. **未来版本**：等待多节点矩形框支持

**示例：**
```
用户：在R-1、R-2、R-3上配置OSPF area 0

处理方式：
- 标注 1：R-1 和 R-2
- 标注 2：R-2 和 R-3
```

## 标注样式说明

### 视觉特性

- **椭圆形状**：完美连接两个设备，适应不同布局
- **虚线边框**：表示"分组"而非"物理边界"
- **半透明背景**：清晰可见但不遮挡连接线
- **居中标签**：区域名称显示在椭圆中心
- **自动旋转**：根据设备位置自动调整角度

### 样式参数

```python
# 椭圆样式
stroke_width: 2px
stroke_dasharray: 5,5  # 虚线
fill_opacity: 0.15     # 半透明

# 文本样式
font_size: 14px
font_weight: bold
text_anchor: middle    # 居中
```

## 完整对话示例

### 场景1：基础 OSPF 配置

```
用户：在R-1和R-2上配置OSPF area 0

助手：我来帮您在R-1和R-2上配置OSPF，并创建Area 0的可视化标注。

1. 配置R-1的OSPF...
   ```
   router ospf 1
   network 192.168.1.0 0.0.0.255 area 0
   ```

2. 配置R-2的OSPF...
   ```
   router ospf 1
   network 192.168.2.0 0.0.0.255 area 0
   ```

3. 创建Area 0区域标注...

✅ 已完成OSPF配置：
   - R-1: 已配置OSPF，接口分配到Area 0
   - R-2: 已配置OSPF，接口分配到Area 0
   - ✅ 已创建"Area 0"可视化标注（椭圆形，连接R-1和R-2）
```

### 场景2：多区域 OSPF 网络

```
用户：配置OSPF多区域网络，R-1和R-2在area 0，R-3和R-4在area 1

助手：我来帮您配置OSPF多区域网络，并创建每个区域的可视化标注。

1. 配置Area 0的OSPF（R-1, R-2）...
2. 配置Area 1的OSPF（R-3, R-4）...
3. 创建Area 0标注...
4. 创建Area 1标注...

✅ 已完成OSPF多区域配置：
   - Area 0（骨干区域）：R-1, R-2 ✅
   - Area 1（普通区域）：R-3, R-4 ✅
   - ✅ 已创建2个区域的可视化标注
```

## 故障排除

### 常见错误及解决方案

#### 错误 1：Node not found

**错误信息：**
```
Node 'R-1' not found in project topology.
```

**原因：**
- 节点名称拼写错误
- 节点未在当前项目中创建

**解决方案：**
1. 检查节点名称是否正确
2. 使用 `gns3_topology_reader` 查看项目中的节点列表

#### 错误 2：Only supports exactly 2 nodes

**错误信息：**
```
This version only supports exactly 2 nodes, got 3.
```

**原因：**
- 提供了2个以上的节点名称

**解决方案：**
- 将节点分成2个一组
- 多次调用工具

#### 错误 3：Failed to connect to GNS3 server

**错误信息：**
```
Failed to connect to GNS3 server.
```

**原因：**
- GNS3 服务器未启动
- 网络连接问题
- 服务器地址配置错误

**解决方案：**
1. 检查 GNS3 服务器是否运行
2. 检查 `.env` 文件中的 GNS3 服务器配置
3. 检查网络连接

## 最佳实践

1. **配置后立即标注**：完成配置后立即创建标注，让用户看到完整结果
2. **使用简洁名称**：使用"Area 0"而非"OSPF Backbone Area Zero"
3. **按逻辑顺序创建**：先创建 Area 0，再创建其他区域
4. **明确告知用户**：在响应中明确告诉用户创建了什么标注
5. **验证配置**：创建标注前先验证配置是否成功

## 未来计划

### 计划中的功能

- [ ] 多节点矩形框标注
- [ ] 智能自动 padding 调整
- [ ] 自定义颜色方案
- [ ] 标注样式自定义
- [ ] 批量标注创建
- [ ] 标注模板系统

## 技术实现

### 核心文件

```
src/gns3_copilot/tools_v2/
├── gns3_drawing_utils.py      # 绘图工具函数
├── gns3_create_area_drawing.py # 区域标注工具
└── __init__.py                # 模块导出

src/gns3_copilot/prompts/
├── drawing_prompt.py           # 绘图专用Prompt
└── base_prompt.py             # 集成绘图指令

tests/tools_v2/
└── test_gns3_area_drawing.py  # 单元测试
```

### 技术栈

- **计算**：Python math 模块（三角函数、距离计算）
- **SVG生成**：标准 SVG 格式字符串拼接
- **颜色管理**：预定义颜色方案字典
- **工具框架**：LangChain BaseTool

## 总结

GNS3 Copilot 的区域标注功能通过简单的3参数接口，为用户提供了强大的可视化能力。AI自动处理所有复杂的计算和绘图工作，让用户专注于网络配置本身，无需关心底层的坐标计算和SVG生成。

**关键优势：**
- 🎯 极简输入：只需提供区域名称和节点名称
- 🤖 智能计算：自动处理所有复杂的坐标和角度计算
- 🎨 专业样式：自动选择颜色和样式
- 📊 可视直观：帮助用户快速理解网络拓扑结构

---
*更新日期：2026-01-02*
*版本：v1.0*
